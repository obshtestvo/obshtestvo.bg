# Публичен сайт на Общество

Публичният сайт на http://www.obshtestvo.bg.

## Бърз старт *(автоматична настройка)*
Без почти никакви усилия може да стартирате проекта на компютъра си.

Нужни са ви единствено:

 - [Vagrant](http://www.vagrantup.com/), ако нямате – [сваляте и инсталирате](
https://www.vagrantup.com/downloads.html)
 - [VirtualBox](https://www.virtualbox.org/), ако нямате – [сваляте и инсталирате](https://www.virtualbox.org/wiki/Downloads)

След което в директорията на проекта пускате 1 команда:

```sh
vagrant up && vagran rsync-auto
# създава виртуална машина и започва автоматична синхронизация
```

Това може да отнеме няколко минути, след което имате работещ сайта на адрес:  [http://localhost:8888/](http://localhost:8888/)

Администратор на сайта е `admin` с парола `admin`, чрез който имате достъп до [административния панел](http://localhost:8888/admin/).

--------------------

## Упътване
Проектът е написан на Python и Django, и използва MySQL.

***Бележка:*** `master` клонът в момента се ползва и за **development** версия на проекта, понеже и самия сайт obshtestvo.bg е в разработка.

### Детайли по автоматичната настройка
Автоматичната настройка създава виртуална машина заемаща 384MB RAM памет и 2GB на диска.
Може да я спирате и пускате с команди от директорията на проекта:

- изклчва се с натискане на <kbd>Ctrl</kbd>+<kbd>C</kbd> и изпълнение на `vagrant halt`
- включва се с `vagrant up && vagrant rsync-auto`

#### Ако не може да се инсталира

Причината може да е във `vagrant`. В някой редки случаи `vagrant` не може да намери основата на която е базирана автоматичната инсталация (*hashicorp/precise32 VM*). В този случай изпълнете:

```
vagrant box add hashicorp/precise32 https://vagrantcloud.com/hashicorp/precise32/version/1/provider/virtualbox.box
```

и пробвайте пак инсталацията.

#### Ако се сайтът се *"счупи"* след update/pull от github

Пробвайте да рестартирате vagrant:

1. Натискате <kbd>Ctrl</kbd>+<kbd>C</kbd> да спрете автоматичната синхронизация

2. Изпълнявате командата `vagrant reload && && vagrant rsync-auto`

Най-вероятно в новата версия, която сте свалили има някакво изискване, което не обновено. Повреме на рестартирането ще се обнови.

#### Как става автоматичната инсталация

За още детайли [вижте какво се инсталира в нея](server/bootstrap_vagrant.sh).

#### Как се влиза във виртуалната машина

Изпълнете `vagrant ssh`. За повече детайли прочетете [документацията на `vagrant`](https://docs.vagrantup.com/v2/).

### Специфика при работата с `django`

Проектът извлича някои настройки от `environment variables`. Без тях `manage.py` няма да работи.
Aко в даден случай е по-удобно, можете да зададете стойности на тези настройки и във файл (`server/.env`). Вижте `server/env.sample` за детайли. .

Променливи които са нужни:
 - име на базата данни от `DATABASE_NAME`
 - потребител за базата данни от `DATABASE_USER`
 - парола за базата данни от `DATABASE_PASS`
 - път то sass от `SASS_BINARY_PATH`
 - дали сайта е в режим разработка или не от `SASS_BINARY_PATH`
 - таен ключ от `SECRET_KEY`
 - facebook тайна от `SOCIAL_AUTH_FACEBOOK_SECRET`

Употребата на `environment variables` позволява сайтът да се настрои без да е нужно
редактиране на файлове и да се избегнат файлове като `local_settings.py` или `ivan_settings.py`.

### Ръчна настройка

Моля разгледайте [скрипта, който инсталира проекта във виртуалната машина](server/bootstrap_vagrant.sh).
Написан е за *debian*-базирани системи. Ако не го разбирате напълно,
и искате още инфо можете да [отворите *issue*](https://github.com/obshtestvo/obshtestvo.bg/issues/new).

### Production среда

След инсталация:

1. В `server/.env`:

	- Променете `DEBUG=True` на `DEBUG=Frue`.
	- Генерирайте нова стойност на `SECRET_KEY` (с `apg -m32` например).

1. Използвайте `Nginx` плюс `uwsgi` server и `uwsgi python plugin`. Могат да се използват примерните конфигурационни файлове в папка `server/`.
1. Настройте уеб сървъра си да сервира статичните файлове, намиращи се в папката `static/` в корена на проекта на URL `/static/`. Могат да се използват примерните конфигурационни файлове в папка `server/`.
1. Уверете се, че по време на deployment се изпълнява командата `python manage.py sass`, за да се компилират статичните `SASS` файлове.
1. Уверете се, че по време на deployment се изпълнява командата `python manage.py collectstatic`, за да се копират всички статични файлове от приложението в `static/`.
1. Уверете се, че по време на deployment се изпълнява командата `python manage.py compress`, за да се компресират всички статични файлове


### Deployment

След първоначалната инсталация, проектът се качва на сървъра с `fab deploy`.
Копирайте `fabric_settings.py.sample` във `fabric_settings.py` и го редактирайте,
за да отговаря на вашите настройки за deploy. След това, процедурата е следната:

1. Правите промени в проекта.
2. `git commit` и `git push` на промените.
3. Изпълнявате `fab deploy` от корена на вашето локално копие.

Скриптът за deploy върши доста от нещата, описани в предишните секции.


##### Почистване на кеша на production системата

```
find /var/cache/nginx/ -type f | xargs rm
```

### Примерна инсталация на Debian-базирана машина

Вижте командите в [инсталационния файл](server/bootstrap_vagrant.sh) за Vagrant.


# Проблеми

Трикове:
1. `virtualenv` средата за проекта е във vagrant виртуалната машина, а не на локална директория, и заради това не
 може да дебъгваш файлове от нея remotely

да имап някакъв мапинг на paths.
 (/home/vagrant/.virtualenvs/obshtestvo -> някъде трябва да се мапва)
 virtualenv --no-site-packages /usr/lib/ckan/default